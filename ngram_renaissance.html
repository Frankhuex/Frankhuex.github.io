<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>N-Gram æ–‡è‰ºå¤å…´</title>
    <style>
        /* --- 1. å…¨å±€ä¸é‡ç½® --- */
        * { box-sizing: border-box; }

        body {
            /* å®šä¹‰ä¸€å¥—ç¾è§‚çš„ç³»ç»Ÿå­—ä½“æ ˆ */
            font-family: 'Segoe UI', 'Microsoft YaHei', 'PingFang SC', "Apple Color Emoji", "Segoe UI Emoji", sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            color: #333;
            line-height: 1.6;
            height: 100vh;
            overflow: hidden; 
            display: flex;
            flex-direction: column;
        }

        /* --- 2. å¸ƒå±€å®¹å™¨ --- */
        .app-container {
            width: 100%;
            height: 100%;
            display: flex;
            gap: 20px;
            padding: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* å·¦ä¾§é¢æ¿ */
        .left-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            min-width: 0;
        }

        /* å³ä¾§é¢æ¿ */
        .right-panel {
            flex: 1.2;
            display: flex;
            flex-direction: column;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            min-width: 0;
        }

        h1 { margin: 0 0 10px 0; text-align: center; color: #2c3e50; font-size: 1.5rem; letter-spacing: 1px; }
        h2 { margin: 0 0 10px 0; font-size: 1.1rem; color: #34495e; border-bottom: 2px solid #eee; padding-bottom: 5px; }

        /* --- 3. ç»„ä»¶æ ·å¼ --- */

        /* å¼ºåˆ¶ Textarea ä½¿ç”¨æ ‡å‡†å­—ä½“ */
        textarea {
            font-family: 'Segoe UI', 'Microsoft YaHei', 'PingFang SC', sans-serif !important;
            letter-spacing: normal;
        }

        /* è¯­æ–™è¾“å…¥æ¡† */
        #corpusInput {
            flex-grow: 1;
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            resize: none;
            overflow-y: auto;
            margin-bottom: 10px;
            
            /* ç»Ÿä¸€å­—ä½“å¤§å°ä¸è¡Œé«˜ */
            font-size: 1rem; 
            line-height: 1.5;
        }
        #corpusInput:focus { border-color: #3498db; outline: none; }

        .train-actions {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 10px;
        }

        /* è¾“å‡ºæ¡† */
        .output-wrapper {
            flex-grow: 1;
            border: 2px solid #b2bec3;
            border-radius: 6px;
            background-color: #2d3436;
            margin-bottom: 10px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .output-box {
            flex-grow: 1;
            padding: 15px;
            color: #dfe6e9;
            font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace; 
            font-size: 1.1rem;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-all;
            overflow-y: auto;
            user-select: text;
            cursor: text;
        }

        /* ä¸­é—´æ§åˆ¶æ  */
        .middle-controls {
            flex-shrink: 0;
            background: #f1f2f6;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #dfe6e9;
            margin-bottom: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            justify-content: space-between;
        }

        .control-group { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }

        /* åº•éƒ¨è¾“å…¥åŒº */
        .input-area {
            flex-shrink: 0;
            display: flex;
            align-items: flex-end;
            gap: 10px;
            background: #ecf0f1;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #bdc3c7;
        }

        #userCharInput {
            flex-grow: 1;
            padding: 10px;
            border: 2px solid #bdc3c7;
            border-radius: 6px;
            outline: none;
            resize: none;
            overflow-y: auto;
            
            /* ç»Ÿä¸€å­—ä½“å¤§å° */
            font-size: 1rem;
            line-height: 1.5;

            /* æ¡Œé¢ç«¯é«˜åº¦ */
            height: auto; 
            min-height: 48px;
            max-height: 130px; 
        }
        #userCharInput:focus { border-color: #3498db; }

        /* æŒ‰é’®æ ·å¼ */
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.1s;
            font-size: 0.9rem;
            white-space: nowrap;
            touch-action: manipulation; /* ç¦ç”¨ç¼©æ”¾ */
            user-select: none;
            -webkit-user-select: none;
        }
        
        button:active { transform: scale(0.98); }
        button:hover { background-color: #2980b9; }
        button.action-btn { background-color: #27ae60; }
        button.action-btn:hover { background-color: #219150; }

        .setting-group {
            display: flex; align-items: center; gap: 5px; font-size: 0.9rem;
            background: #fff; padding: 4px 8px; border: 1px solid #bdc3c7; border-radius: 4px;
        }
        .setting-group input[type="number"] {
            width: 45px; border: none; border-bottom: 1px solid #bdc3c7; text-align: center; outline: none;
            font-family: inherit;
        }
        .switch-label { display: flex; align-items: center; cursor: pointer; font-weight: bold; font-size: 0.9rem; }
        .switch-label input { margin-right: 6px; }

        /* æ–‡æœ¬æ ‡è®°é¢œè‰² */
        .text-user { color: #ff7675; font-weight: bold; }
        .text-model { color: #55efc4; }
        .text-cursor {
            display: inline-block; width: 8px; height: 1.2rem; background-color: #dfe6e9;
            animation: blink 1s infinite; vertical-align: middle; margin-left: 2px;
        }
        @keyframes blink { 50% { opacity: 0; } }
        .topic-divider {
            border: 0; height: 1px; background-image: linear-gradient(to right, rgba(0,0,0,0), rgba(255,255,255,0.5), rgba(0,0,0,0));
            margin: 20px 0; position: relative; width: 100%;
        }
        .topic-divider::after {
            content: "æ–°è¯é¢˜"; position: absolute; left: 50%; top: -10px; transform: translateX(-50%);
            background: #2d3436; padding: 0 10px; color: #b2bec3; font-size: 0.8rem;
        }

        /* --- 4. ç§»åŠ¨ç«¯é€‚é… --- */
        @media (max-width: 768px) {
            body { height: auto; overflow-y: auto; }
            
            .app-container { 
                flex-direction: column; 
                padding: 5px; 
                gap: 15px; 
            }
            
            .left-panel, .right-panel { width: 100%; padding: 10px; box-shadow: none; border: 1px solid #eee; }
            #corpusInput { flex-grow: 0; min-height: 100px; max-height: 240px; }
            .output-wrapper { flex-grow: 0; height: auto; }
            .output-box { min-height: 120px; max-height: 250px; }
            h1 { font-size: 1.2rem; }
            .middle-controls { flex-direction: column; align-items: stretch; gap: 10px; }
            .control-group { justify-content: space-between; }
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 3px; }
        .output-box::-webkit-scrollbar-track { background: #2d3436; }
        .output-box::-webkit-scrollbar-thumb { background: #636e72; }
    </style>
</head>
<body>

<div class="app-container">
    
    <!-- å·¦ä¾§ï¼šè¯­æ–™é¢æ¿ -->
    <div class="left-panel">
        <h2>ğŸ“‚ è®­ç»ƒè¯­æ–™</h2>
        <textarea id="corpusInput" class="corpus-auto-mobile" placeholder="åœ¨æ­¤ç²˜è´´è¯­æ–™...">
â€œæ‰€ä»¥ï¼Œè¿˜æœ‰è¦æé—®çš„åŒå­¦å—ï¼Ÿâ€
è‹å¯’æ‹¿ç€è¯ç­’ï¼Œç›®å…‰å¯»æ‰¾ç€ä¸¾æ‰‹çš„åŒå­¦ã€‚ä»–çš„èƒŒåæ˜¯ä¸€å—å¤§æ˜¾ç¤ºå±ï¼Œä¸Šé¢å†™ç€â€œç­”ç–‘æ—¶é—´â€ï¼Œè€Œèˆå°ä¸Šæ–¹æŒ‚ç€çš„æ¨ªå¹…åˆ™å‘Šè¯‰äº†æ‰€æœ‰äººï¼Œç°åœ¨æ­£åœ¨ä¸¾åŠçš„æ˜¯â€œç§‘å­¦å®¶è¿›æ ¡å›­â€æ´»åŠ¨ã€‚
è‹å¯’ä¸€èº«ç™½è‰²è¡¬è¡«ï¼Œä¸‹é…ä¸€æ¡ç¬”ç›´çš„è¥¿è£…è£¤ï¼Œæ­çš„å´æ˜¯ä¸€åŒè¿åŠ¨é‹ã€‚å¹´è½»çš„è„¸åºä¼¼ä¹è®©ä»–å¾ˆéš¾å’Œç§‘å­¦å®¶é‚£è€ç»ƒçš„å½¢è±¡æ­ä¸Šè¾¹ï¼Œä¸è¿‡ä»–å´æ˜¯ä¸€ä¸ªè´§çœŸä»·å®çš„ç§‘å­¦å®¶ã€‚åå…­å²å°±è¢«æå‰æ‹›è¿›å¤§å­¦ï¼Œä¸¤å¹´ä¹‹å‰å·²ç»å‘è¡¨äº†ç¬¬ä¸€ç¯‡è®ºæ–‡ï¼Œç°åœ¨çš„ä»–ï¼Œæ¯”å¤§éƒ¨åˆ†å¤§è‡ªå·±äº”å²çš„äººéƒ½æ›´æœ‰èµ„æ ¼è¯´æ˜¯ä¸€åç§‘å­¦å®¶ã€‚
â€œå°±è¿™ä½åŒå­¦å§ï¼Œé‚£ä¸ªé»‘è£™å­çš„å¥³ç”Ÿã€‚â€è‹å¯’å‘è§‚ä¼—å¸­ä¸ŠæŒ‡åˆ°ã€‚ä¸€è¾¹çš„ä¸»æŒäººå¾ˆå¿«æ‰¾åˆ°äº†é‚£ä¸ªé€‰ä¸­çš„äººï¼ŒæŠŠè¯ç­’é€’ç»™äº†å¥¹ã€‚
å¥³å­©å¤§æ–¹æ¥è¿‡è¯ç­’ï¼Œè¿…é€Ÿç«™èµ·ï¼Œæ¯«æ— å¿¸æ€©ä¹‹æ€ã€‚
â€œæˆ‘æ˜¯ä¸€ä¸ªè‡ªç§çš„äººï¼ŒçŸ¥é“åœ¨åˆ©å·±å’Œä¸ºä»–äººä¸­æŠ‰æ‹©å¾ˆéš¾ã€‚é‚£æ‚¨ä½œä¸ºç§‘å­¦å®¶ï¼Œæ˜¯å¦‚ä½•çœ‹å¾…ç§‘ç ”è¿‡ç¨‹ä¸­æ›´å¤šåˆ©å·±æˆ–æ˜¯ä¸ºç¤¾ä¼šä½œè´¡çŒ®çš„é—®é¢˜å‘¢ï¼Ÿâ€
è¯éŸ³åˆšè½ï¼Œè§‚ä¼—å¸­ä¸­ä¸€ç‰‡â€œå””â€çš„å£°éŸ³ï¼Œç´§æ¥ç€å®‰é™ä¸‹æ¥ï¼Œç›®å…‰èšç„¦åœ¨è‹å¯’èº«ä¸Šã€‚
ä»–æœ¬èº«ä¹Ÿæœ‰è¯§å¼‚â€”â€”ä»–å·²ä¹ æƒ¯äºè§£å†³å¦‚ä½•å­¦ä¹ çš„é—®é¢˜ï¼Œè€Œè¿™ä½å¥³å­©æ‹‹å‡ºçš„é—®é¢˜äº¦è®©ä»–å¼€å§‹é‡æ–°æ€è€ƒè‡ªå·±è¿›è¡Œç§‘ç ”çš„ç›®çš„æ¥ã€‚è‹å¯’æ˜ç™½è‡ªå·±å¿…é¡»å›ç­”å¥½è¿™ä¸ªé—®é¢˜ï¼Œå› ä¸ºå‡ ä¹æ‰€æœ‰åŒå­¦çš„æ³¨æ„åŠ›å·²é›†ä¸­äºæ­¤ã€‚
â€œå—¯ï¼Œâ€ä»–å‡†å¤‡å¼€å£ï¼Œä»æ€è€ƒçŠ¶æŠ¬èµ·å¤´æ¥ï¼Œæ°å·§æ’ä¸Šäº†å¥³å­©æŠ•æ¥çš„ç›®å…‰ã€‚
å¥¹çš„çœ¼ç›å¾ˆå¤§ï¼Œé¼»æ¢å¾ˆé«˜ï¼Œå¾®ç¬‘å¸¦å‡ºçš„é¢çªåœ¨è‹å¯’çœ¼ä¸­åˆ’ä¸‹å°è®°ã€‚ä¸å¥½ï¼Œè‹å¯’æš—é“ã€‚ä»–çš„å¿ƒå·²ç„¶ä¹±äº†ï¼Œæ˜¯å¥³å­©ç›®å…‰ä¸­çš„ç–‘æƒ‘ï¼ŒæœŸå¾…ä»¥åŠä»¿ä½›æ— çŸ¥èˆ¬çš„å¤©çœŸå°†è‹å¯’æ³¨æ„åŠ›æ‹‰å›ã€‚
â€œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é—®é¢˜ï¼Œæˆ‘è¿™ä¸€è·¯å…¶å®å¹¶éå¦‚åˆ«äººçœ¼ä¸­ä¸€èˆ¬ä¸€å¸†é£é¡ºçš„â€¦â€¦â€

é™ˆç§‹å®œå¾®å¾®ç”¨åŠ›å°†è„–å­å‘åé¡¶ï¼Œä¸€å¦‚å¾€å¸¸ä¸Šå°è¡¨æ¼”æ—¶ï¼Œæ€»æ˜¯å±•ç°ä¼˜ç¾çš„ä½“æ€ã€‚ä½†ä¸å¹³æ—¶ä¸åŒçš„æ˜¯ï¼Œä»Šå¤©çš„â€œè¡¨æƒ…ç®¡ç†â€å¥½åƒæ›´åŠ å›°éš¾â€”â€”å¥¹æ„Ÿå—åˆ°é¢ˆä¸‹åŠ¨è„‰çš„æ›²å¼ ä¸æåŠ¨ï¼Œåˆæœ‰äº›éš¾ä»¥æ§åˆ¶å‘¼å¸çš„èµ·ä¼ï¼ŒèƒŒä¸Šä¹Ÿä¸çŸ¥æ€çš„å¼€å§‹ç´§å¼ å†’æ±—â€”â€”ä½†æ˜¯ç”±äºé•¿æœŸèˆè¹ˆå½¢æ€çš„è®­ç»ƒï¼Œåªæœ‰å¥¹è‡ªå·±èƒ½å¯Ÿè§‰å¼‚æ ·ã€‚
â€œå”‰ï¼ŒçœŸæ˜¯ç³Ÿäº†ï¼Œæ˜æ˜â€¦â€¦â€
æ˜æ˜å‡†å¤‡äº†å¥½å‡ éæé—®çš„é—®é¢˜ï¼Œæ€ä¹ˆåˆ°ç°åœºå°±å¤±çµäº†å‘¢ï¼Ÿæœ¬æ¥è¦å½“ç€å¤§å®¶çš„é¢è¯´è‡ªå·±â€œè‡ªç§â€å°±å·²ç»å¤Ÿè‰°éš¾çš„äº†ï¼Œç°åœ¨åˆæè¿™å‡ºâ€¦â€¦çƒ¦æ­»äº†ï¼Œéƒ½æ€ªè¿™ä¸ªç§‘å­¦å®¶ï¼Œæé—®å°±æé—®ï¼Œéè¦èµ°è¿™ä¹ˆè¿‘æ¥å¬å¹²å˜›â€¦â€¦
æ­£æƒ³ç€ï¼Œè‹å¯’çš„ç›®å…‰å¯¹äº†ä¸Šæ¥ã€‚é™ˆç§‹å®œå¿ƒé‡Œå¤§éª‚â€œç³Ÿç³•â€ï¼Œèµ¶ç´§æŠ¿äº†ä¸‹å˜´â€”â€”å“ªçŸ¥é“è¿™å¾®è—é…’çªçš„å¾®ç¬‘æ­£æ˜¯å°„å…¥è‹å¯’å¿ƒé‡Œçš„ç¬¬ä¸€æ”¯ç®­ã€‚
â€œå…¶å®ä¸Šé«˜ä¸­çš„æ—¶å€™ï¼Œæˆ‘ä¹Ÿæƒ³è¿‡è¿™ä¸ªé—®é¢˜ã€‚â€è‹å¯’è¯´é“ï¼Œâ€œä¹Ÿæ˜¯åœ¨ä½ è¿™ä¸ªå¹´çºªã€‚ä¸è¿‡åæ¥æˆ‘ä¹Ÿå°±é‡Šç„¶äº†ï¼Œä¸å…¶çº ç»“äºè¿™ä¸ªé—®é¢˜ï¼Œä¸å¦‚å¤šåšç‚¹æœ‰æ„ä¹‰çš„äº‹ã€‚æ¯•ç«Ÿï¼Œäººæ€»æ˜¯åˆ©å·²ä¼˜å…ˆçš„ã€‚â€
ä¼šåœºå“èµ·äº†æŒå£°ï¼Œè‚‰çœ¼å¯è§çš„æ˜¯ï¼Œæœ‰å¾ˆå¤šå­¦ç”Ÿé™·å…¥äº†æ²‰æ€ï¼Œè‹å¯’çŸ¥é“ï¼Œè‡ªå·±æ¥åŠè¿™ä¸ªè®²åº§çš„ç›®çš„è¾¾æˆäº†ã€‚
â€¦â€¦
è‹å¯’ä»åå°é€€åœºï¼Œåˆšèµ°å‡ºæŠ¥å‘Šå…ï¼Œä¾¿å¬åˆ°èº«åæœ‰ä¸€é˜µè„šæ­¥å£°ã€‚å›å¤´ä¸€çœ‹ï¼ŒåŸæ¥æ˜¯åˆšæ‰æé—®çš„é‚£ä¸ªå¥³å­©ã€‚
â€œè‹å¯’è€å¸ˆã€‚â€é™ˆç§‹å®œå–˜äº†å£æ°”ï¼Œæ‰æŠŠå‰©ä¸‹çš„åŠå¥è¯è¯´å‡ºæ¥ï¼Œâ€œå¯ä»¥ç»™æˆ‘ä¸€ä¸ªç­¾åå—ï¼Ÿâ€

å›æ•™å®¤çš„è·¯ä¸Šï¼ŒåŒå­¦ä»¬è¿˜å½å½å–³å–³åœ°è®®è®ºç€åˆšæ‰çš„äº‹ï¼Œçœ‹è§é™ˆç§‹å®œæ­£ä»åé¢è·Ÿä¸Šæ¥ï¼Œç›®å…‰ä¸€é½æŠ•å‘å¥¹ã€‚
â€œä½ åˆšå¹²ä»€å›å»äº†ï¼Ÿæ€ä¹ˆæ²¡ä¸€èµ·ä¸Šæ¥ï¼Ÿâ€ä¸€ä¸ªåŒå­¦é—®ã€‚
â€œæ²¡å¹²ä»€ä¹ˆâ€¦â€¦â€é™ˆç§‹å®œä¼¼ä¹æœ‰äº›å¿ƒä¸åœ¨ç„‰ï¼Œå°±åƒå¥¹ç¬¬ä¸€æ¬¡ä¸Šå°è¡¨æ¼”ç»“æŸåé‚£æ ·ã€‚åªå¬é‚£ä¸ªåŒå­¦ç»§ç»­é“ï¼š
â€œç§‹å®œï¼Œä½ åˆšåˆšé‚£ä¸ªé—®é¢˜çœŸæ˜¯å¤ªæ¼‚äº®äº†ï¼æ€ä¹ˆè¯´çš„æ¥ç€ï¼Œâ€˜æˆ‘æ˜¯ä¸€ä¸ªè‡ªç§çš„äººâ€¦â€¦â€™â€
åé¢å¥¹è¯´äº†ä»€ä¹ˆï¼Œé™ˆç§‹å®œä¸€å¥éƒ½æ²¡æœ‰å¬è§ã€‚
å¥¹å‘ç°ï¼Œå¥¹è‹äº†ã€‚
èŠ±æº…æŸ“äº†æ´ç™½çš„å¢™å£ï¼Œç•™ä¸‹ä¸€ä¸ªå®‰é™çš„ä¸–ç•Œã€‚
çœ¼å‰ä¹‹äººå˜´å·´å¼ åˆï¼Œåƒæ˜¯ç«­åŠ›æŒ£æ‰åœ¨æ°´é¢çš„é‡‘é±¼ã€‚
é‚£è°æ¥æ•‘èµå¥¹ï¼Ÿ
å½“ç„¶æ˜¯å¼ å‡¯æ´‹ã€‚
è‡³å°‘å¥¹æ˜¯è¿™ä¹ˆæƒ³çš„ã€‚
ä½†å¼ å‡¯æ´‹ä¼¼ä¹å¹¶ä¸è¿™ä¹ˆæƒ³ã€‚
å¼ å‡¯æ´‹æ€»æ˜¯å¾ˆæ„¿æ„åšè¿™ä¸€ç±»çš„äº‹æƒ…çš„ã€‚
ä½œä¸ºå¹´çºªè½»è½»å°±æœ‰å››å…·æ£ºæçš„ä¸€ä¸ªäººï¼Œä»–ä¸€å‘æ“…é•¿åšè¿™ç±»äº‹æƒ…ã€‚
ä½ ä¸€å®šä¼šå¾ˆå¥½å¥‡ã€‚è¿™ä¸ªç‹¬ç‰¹çš„åå­—â€œå¼ å‡¯è¯¦â€åˆ°åº•æŒ‡è°ï¼Ÿ
åˆ«æ€¥ï¼Œä½œè€…ä¹Ÿæ€¥ã€‚
å½“ç„¶å¼ å‡¯æ´‹æ˜¯ç§‹å®œçš„åŒå­¦ï¼Œä¹ƒè‡³å‘å°ã€‚ä½œä¸ºåŸé‡Œå”¯ä¸€ä¸€å®¶æ®¡ä»ªé¦†çš„ç»§æ‰¿äººï¼Œä»–ä»13å²å¼€å§‹çš„ç”Ÿæ—¥ç¤¼ç‰©å°±æ˜¯è±ªåæ¾æœ¨å¤§æ£ºæã€‚ä»–çˆ¶äº²çš„è¯´æ³•æ˜¯è¿™æ ·çš„ï¼šâ€œè¿™å­©å­åå­—å¤ªé˜³é—´äº†ï¼Œå¹²æˆ‘ä»¬è¿™è¡Œçš„ï¼Œèº«ä¸Šå¤šå°‘å¾—å…ˆæ²¾ç‚¹è„ä¸œè¥¿ã€‚â€å¤šè°¢è¿™ä¸ªå¥½åå­—ï¼Œä»–ä»å°è¿æ°”å°±å¥½ã€‚ä»ä¸‰å²æ¡åˆ°è‘µèŠ±å®å…¸ã€ä¸ƒå²æ„å¤–å­¦ä¼šå¾®ç§¯åˆ†ã€åäºŒå²é¢†æ‚Ÿç¥å­¦çŸ¥è¯†ï¼Œåˆ°åå…­å²å¹¸è¿è€ƒè¿›æ¢…å·å¤§å­¦â€”â€”å°±æ˜¯è‹å¯’åå…­å²è€ƒå…¥çš„é‚£æ‰€å¤§å­¦ï¼Œä»–é™¤äº†è¢«ç§°ä¸ºç¥ç«¥ï¼Œè¿˜æœ‰ä¸€ä¸ªå¤–å·"Lucky Shake"ï¼Œç®€ç§°â€œLSâ€ã€‚
ä½œä¸ºå…¨å¸‚çš†çŸ¥çš„å¤•é˜³ä¼ä¸šï¼Œè€å¼ æ®¡ä»ªæœåŠ¡é›†å›¢â€”â€”è¯´ä¸ä¸Šé›†å›¢ï¼Œä¹Ÿæ²¡å»å·¥å•†å±€æ³¨å†Œï¼Œæœ‰çš„åªæ˜¯LSä»–çˆ¸è‡ªå·±è´´çš„æ‹›ç‰Œâ€”â€”åœ¨å»å¹´åˆšè¿‡å®ƒçš„100å‘¨å¹´åè¯ã€‚è‡³ä»Šä»ç„•å‘ç€å€”å¼ºçš„æ´»åŠ›ï¼Œè€å¼ å®¶çš„æ”¶å…¥ä¹Ÿä»¥æ¯å¹´1%çš„å¢å¹…ç¨³æ­¥æ¥è¿‘å…¨å¸‚äººå‡æ°´å‡†ã€‚
ç§‹å®œå’ŒLSä¸ºä»€ä¹ˆå…³ç³»è¿™ä¹ˆå¥½æ²¡äººçŸ¥é“ã€‚åˆ«äººåªçŸ¥é“ä»–ä»¬ä¸ƒå²ä¹‹å‰å°±å·²ç»è®¤è¯†äº†ã€‚å‡­å€Ÿå‹‡æ°”ã€æ™ºæ…§ä¸è¿æ°”ï¼ˆä¸»è¦æ˜¯æœ€åä¸€ä¸ªï¼‰ï¼Œå¼ å‡¯è¯¦å¤šæ¬¡è§ä¹‰å‹‡ä¸ºã€å¸®åŠ©ä»–äººï¼Œæ˜¯å‡ºäº†åçš„çƒ­å¿ƒè‚ ã€‚ä¸¤å¹´å‰çš„ä¸€åœºç«ç¾ä¸­ï¼Œå°±æ˜¯ä»–å°†ç§‹å®œä»ç«åœºä¸­æ¯«å‘æ— æŸåœ°æ•‘äº†å‡ºæ¥ã€‚

è™½ç„¶ä¸çŸ¥é“åŸå› ï¼Œé™ˆç§‹å®œç°åœ¨æ˜¯ä¸ªè´§çœŸä»·å®çš„è‹äººã€‚
ä½†å¼ å‡¯æ´‹ä¸æ˜¯ã€‚
å¼ å‡¯æ´‹å¸¸å¹´åœ¨ç«åœºã€æ²³åº•ã€é«˜ç©ºè¿™ç±»å±é™©åœºæ‰€ç©¿æ¢­ï¼Œå¥åº·ç†åº”å—åˆ°æå¤§æŸå®³ï¼Œå…¶ä¸­è‡ªç„¶åŒ…æ‹¬å¬åŠ›ï¼›ä½†ç°åœ¨ï¼Œå¼ å‡¯æ´‹é™¤äº†åœ¨å„å¤§ä½“è‚²èµ›äº‹ä¸­å±¡å±¡è·å¥–ä¹ƒè‡³ç ´çºªå½•çš„åŒæ—¶ï¼Œä»–çš„å¬åŠ›ä¹Ÿå‡ºå¥‡åœ°å¥½ã€‚æ®ä»–æ‰€è¯´ï¼Œè¿™éƒ½æ˜¯ä»–ç»å¸¸åœ¨ä»–çˆ¶äº²å¼ å‡¯é™†åˆ¶ä½œçš„æ£ºæé‡Œç¡è§‰çš„ç¼˜æ•…ã€‚
æ‰€ä»¥åœ¨å¾—çŸ¥é™ˆç§‹å®œè‹äº†çš„æ¶ˆæ¯ä»¥åï¼Œå¼ å‡¯æ´‹ç¬¬äºŒå¤©å°±é¡¶ç€å…¨ç­åŒå­¦è®¶å¼‚çš„ç›®å…‰ï¼Œæ‰›ç€ä¸€å…·çœ‹ä¸Šå»é¢‡ä¸ºæ²‰é‡çš„æ£ºæèµ°è¿›æ•™å®¤ã€‚

å‰ä¸€å¤©æ™šä¸Šã€‚
â€œæ‰€ä»¥ï¼Œæˆ‘ä»¬çœŸçš„è¦ä¸‹å»å—ï¼Ÿâ€
å¼ å‡¯æ´‹ä¸å®‰åœ°çœ‹å‘çˆ¶äº²ï¼Œåè€…åˆ™æ˜¯ç¼“ç¼“ç‚¹äº†å¤´ã€‚
â€œæ‘¸é‡‘æ ¡å°‰å·²ç»æ¢å¥½äº†è·¯å­ï¼Œè¿™ä¸‹é¢çš„å¢“ä¸ç®€å•ã€‚ä½•å†µï¼Œè¿™ä¹Ÿæ˜¯ç£¨ç‚¼ä½ å€’æ–—èƒ½åŠ›çš„å¥½æœºä¼šã€‚â€
è¯´ç€ï¼Œä¸€è¡Œäººä¸€ä¸ªæ¥ä¸€ä¸ªåœ°ä¸‹åœ°ã€‚
åˆšèµ°å‡ æ­¥è¿œï¼Œå¼ å‡¯è·¯å°±è¢«ä¸€ä¸ªæ–¹å½¢æœ¨å¤´æŒ¡ä½äº†å»è·¯ã€‚
â€œæ£ºæ¤ï¼Ÿç«Ÿç„¶æ‘†åœ¨å…¥å£ä¹ˆï¼Ÿâ€
å¼ å‡¯æ´‹æ¢å¤´çœ‹å»ï¼Œæ ¹æ®ç»éªŒä»–åˆ¤æ–­è¿™æ£ºæ¤çš„æè´¨æ˜¯ä¹Œå°æœ¨ï¼Œå•çœ‹ä½“å‹ï¼Œä¼°è®¡å¸‚ä»·äºŒä¸‰åä¸‡ã€‚
æ­£æ¬²æ‰“å¼€ã€‚
â€œåˆ«åŠ¨ï¼â€å¼ å‡¯æ´‹å“äº†ä¸€è·³ï¼Œâ€œä½ å°±ä¸æ‹…å¿ƒé‡Œé¢æœ‰æ°¨æ°”å—ï¼Ÿâ€
â€œé‚£æ€ä¹ˆåŠï¼Ÿâ€å¼ å‡¯æ´‹è¿·æƒ‘æäº†ã€‚
â€œè€è§„çŸ©ï¼Œæ‰“å¼€ä¸€æ¡ç¼ï¼Œæ‰‡é—»ã€‚â€
å°‘è®¸æ©™ç»¿è‰²ä½“é£˜äº†å‡ºæ¥ã€‚
å¼ å‡¯æ´‹æå‡ºä¸€ä¸ªæ‰“ç«æœºã€‚
â€œä½ è¿™æ˜¯åœ¨å¹²ä»€ä¹ˆï¼Ÿâ€çˆ¶äº²ç–‘æƒ‘æäº†ã€‚
â€œå°¾æ°”å¤„ç†å•Šã€‚â€
â€œå°¾æ°”å¤„ç†ä¸ªé¬¼ï¼è°TMæ•™ä½ å°¾æ°”å¤„ç†æ˜¯ç”¨æ‰“ç«æœºç‚¹ç‡ƒçš„ï¼Ÿï¼â€
â€œé‚£æ¢ç©¶ä¸€ä¸‹å®ƒæ˜¯å¦å¯ç‡ƒä¸ä¹Ÿæœ‰åŠ©äºäº†è§£å®ƒçš„æ€§è´¨å˜›ã€‚â€
çˆ¶äº²æ°”åäº†ã€‚
â€œä½ éƒ½ä¸éªŒçº¯çš„å—ï¼Ÿçˆ†ç‚¸äº†æ€ä¹ˆåŠï¼Ÿâ€
â€œæ²¡äº‹ï¼Œæˆ‘ä¸æ€•ç«ã€‚â€
â€œä½ ä¸ªâ€¦â€¦â€
å¼ å‡¯æ´‹æœ€ç»ˆè¿˜æ˜¯æŒ‰ä¸‹äº†æ‰“ç«æœºã€‚
â€¦â€¦
å¼ å‡¯æ´‹è‡³ä»Šå¿˜ä¸äº†ä»–ä»¬é€ƒå‡ºç›—æ´æ—¶çš„ç‹¼ç‹ˆä»¥åŠå›å®¶åè¢«æš´æçš„ç—›ã€‚

å…¨ç­åŒå­¦çœ‹ç€çƒ§ç„¦çš„æ£ºæé¢é¢ç›¸è§‘ã€‚
â€œä¸ä¸ä¸ï¼Œè¿™ä¸æ˜¯é‚£ä¸€å…·ï¼Œé‚£ä¸€å…·æˆ‘è‡ªå·±ç”¨ç€å‘¢ï¼Œä½†æˆ‘çˆ¸è¯´ä¸€ä¸ªäººä¸èƒ½åŒæ—¶æ‹¥æœ‰äº”å…·æ£ºæï¼Œæ‰€ä»¥å°±è®©æˆ‘æŠŠè‡ªå·±çš„ä¸€å…·æ£ºæå¸¦è¿‡æ¥äº†ã€‚â€å¼ å‡¯æ´‹æ…Œå¿™è§£é‡Šã€‚
å¾ˆå¿«ï¼Œæ•´ä¸ªå­¦æ ¡éƒ½çŸ¥é“å¼ å‡¯æ´‹å¸¦äº†ä¸€å…·çƒ§ç„¦çš„æ£ºææ¥å­¦æ ¡ã€‚
æ‰€ä»¥å½“æ ¡é•¿ä¸€è„¸ç–‘æƒ‘åœ°çœ‹ç€å¼ å‡¯æ´‹å’Œè¢«ä»–ååœ¨èº«ä¸‹çš„æ£ºææ—¶ï¼Œå¼ å‡¯æ´‹æ·¡æ·¡åœ°è¯´ï¼š
â€œè¿™å°†æˆä¸ºæˆ‘çš„è¯¾æ¡Œã€‚â€     
        </textarea>
        <div class="train-actions">
            <div id="trainStatus" style="font-size:0.85rem; color:#e74c3c; margin-right:10px;">æœªè®­ç»ƒ</div>
            <button onclick="trainModels()">ğŸš€ è®­ç»ƒæ¨¡å‹</button>
        </div>
    </div>

    <!-- å³ä¾§ï¼šäº¤äº’é¢æ¿ -->
    <div class="right-panel">
        <h1>N-Gram æ–‡è‰ºå¤å…´</h1>

        <!-- 1. è¾“å‡ºå±å¹• -->
        <div class="output-wrapper">
            <div id="consoleOutput" class="output-box" onclick="focusInputIfEmptySelection()">
                <div style="color:#b2bec3; text-align:center; padding-top:20px; font-style:italic;">
                    è¯·å…ˆç‚¹å‡»å·¦ä¾§â€œè®­ç»ƒæ¨¡å‹â€ï¼Œç„¶ååœ¨æ­¤å¤„å¼€å§‹åˆ›ä½œ...
                </div>
            </div>
        </div>

        <!-- 2. ä¸­é—´æ§åˆ¶æ  -->
        <div class="middle-controls">
            <div class="control-group">
                <div>
                    <input type="radio" id="modelBigram" name="modelType" value="bigram"> <label for="modelBigram">Bigram</label>
                    <input type="radio" id="modelTrigram" name="modelType" value="trigram" checked> <label for="modelTrigram">Trigram</label>
                </div>
                <label class="switch-label" title="å»¶ç»­ä¸Šæ–‡">
                    <input type="checkbox" id="continuousMode" checked> ğŸ”— è¿ç»­
                </label>
            </div>

            <div class="control-group">
                <div class="setting-group" title="AIæ¯æ¬¡ç”Ÿæˆçš„å­—æ•°">
                    <label>AIå­—æ•°:</label>
                    <input type="number" id="aiCount" value="1" min="1" max="100">
                </div>
                <button class="action-btn" onclick="triggerRandomGeneration()">ğŸ² éšæœºç”Ÿæˆ</button>
            </div>
        </div>

        <!-- 3. åº•éƒ¨è¾“å…¥æ  -->
        <div class="input-area">
            <textarea id="userCharInput" placeholder="è¾“å…¥æ–‡å­— (Enterå‘é€ï¼ŒCtrl+Enteræ¢è¡Œ)..."></textarea>
            <button onclick="processInput()" style="height: auto; align-self: stretch; font-weight:bold;">å‘é€</button>
        </div>
        
        <div style="text-align:right; font-size:0.8rem; color:#999; margin-top:5px;">
             å¿«æ·é”®: Enter å‘é€ / Ctrl+Enter æ¢è¡Œ
        </div>
    </div>
</div>

<script>
// --- å“åº”å¼é«˜åº¦è°ƒæ•´é€»è¾‘ ---
function initResponsiveResize() {
    const userResultBox = document.getElementById('userCharInput');
    const corpusBox = document.getElementById('corpusInput');

    function setHeight(el) {
        el.style.height = 'auto'; 
        if (el.id === 'corpusInput' && window.innerWidth > 768) {
            el.style.height = '100%'; 
            return;
        }
        let newHeight = el.scrollHeight;
        el.style.height = newHeight + 'px';
    }

    userResultBox.addEventListener('input', () => setHeight(userResultBox));
    corpusBox.addEventListener('input', () => setHeight(corpusBox));

    window.addEventListener('resize', () => {
        if (window.innerWidth > 768) {
            corpusBox.style.height = ''; 
        } else {
            setHeight(corpusBox);
        }
        setHeight(userResultBox);
    });

    if (window.innerWidth <= 768) setHeight(corpusBox);
    setHeight(userResultBox);
}
window.addEventListener('DOMContentLoaded', initResponsiveResize);


// --- N-Gram ç®—æ³•æ ¸å¿ƒ ---
class Counter extends Map {
    get(key) { return super.get(key) || 0; }
    add(key, val = 1) { this.set(key, this.get(key) + val); }
}

function weightedRandom(choices, weights) {
    let total = weights.reduce((a, b) => a + b, 0);
    let randomVal = Math.random() * total;
    let cumulative = 0;
    for (let i = 0; i < choices.length; i++) {
        cumulative += weights[i];
        if (randomVal < cumulative) return choices[i];
    }
    return choices[choices.length - 1]; 
}

class SimpleNGramLMBase {
    constructor() {
        this.vocab = new Set();
        this.unigram_counts = new Counter();
        this.bigram_counts = new Map(); 
        this.trigram_counts = new Map();
        this.smoothing = 1.0;
        this.vocab_size = 0;
    }
    get_bigram_count(w1, w2) {
        if (!this.bigram_counts.has(w1)) return 0;
        return this.bigram_counts.get(w1).get(w2);
    }
    get_trigram_count(w1, w2, w3) {
        let key = w1 + "|" + w2;
        if (!this.trigram_counts.has(key)) return 0;
        return this.trigram_counts.get(key).get(w3);
    }
    getRandomChar() {
        let validChars = Array.from(this.vocab).filter(c => c !== '<s>' && c !== '</s>');
        if (validChars.length === 0) return ' '; 
        return validChars[Math.floor(Math.random() * validChars.length)];
    }
}

class SimpleBigramLM extends SimpleNGramLMBase {
    train(corpus) {
        for (let i = 0; i < corpus.length; i++) {
            let word = corpus[i];
            this.vocab.add(word);
            this.unigram_counts.add(word);
            if (i < corpus.length - 1) {
                let next_word = corpus[i+1];
                if (!this.bigram_counts.has(word)) this.bigram_counts.set(word, new Counter());
                this.bigram_counts.get(word).add(next_word);
            }
        }
        this.vocab_size = this.vocab.size;
    }
    get_probability(word, given_word) {
        let bigram_c = this.get_bigram_count(given_word, word) + this.smoothing;
        let unigram_c = this.unigram_counts.get(given_word) + this.smoothing * this.vocab_size;
        return bigram_c / unigram_c;
    }
    generate_word(given_word) {
        let next_counter = this.bigram_counts.get(given_word);
        let next_words = next_counter ? Array.from(next_counter.keys()) : [];
        if (next_words.length === 0) return '</s>';
        let probabilities = next_words.map(w => this.get_probability(w, given_word));
        return weightedRandom(next_words, probabilities); 
    }
}

class SimpleTrigramLM extends SimpleNGramLMBase {
    train(corpus) {
        for (let i = 0; i < corpus.length; i++) {
            let word = corpus[i];
            this.vocab.add(word);
            this.unigram_counts.add(word);
            if (i < corpus.length - 1) {
                let next_word = corpus[i+1];
                if (!this.bigram_counts.has(word)) this.bigram_counts.set(word, new Counter());
                this.bigram_counts.get(word).add(next_word);
            }
            if (i < corpus.length - 2) {
                let next_word = corpus[i+1];
                let next_next_word = corpus[i+2];
                let bigram_key = word + "|" + next_word;
                if (!this.trigram_counts.has(bigram_key)) this.trigram_counts.set(bigram_key, new Counter());
                this.trigram_counts.get(bigram_key).add(next_next_word);
            }
        }
        this.vocab_size = this.vocab.size;
    }
    get_probability(word, given_word) {
        if (Array.isArray(given_word) && given_word.length === 2) {
            let [w1, w2] = given_word;
            let trigram_c = this.get_trigram_count(w1, w2, word) + this.smoothing;
            let bigram_c = this.get_bigram_count(w1, w2) + this.smoothing * this.vocab_size;
            return trigram_c / bigram_c;
        } else {
            let bg_count = this.get_bigram_count(given_word, word) + this.smoothing;
            let ug_count = this.unigram_counts.get(given_word) + this.smoothing * this.vocab_size;
            return bg_count / ug_count;
        }
    }
    generate_word(given_word) {
        let next_words = [];
        if (Array.isArray(given_word) && given_word.length === 2) {
            let key = given_word[0] + "|" + given_word[1];
            let counter = this.trigram_counts.get(key);
            if (counter) next_words = Array.from(counter.keys());
            else return this.generate_word(given_word[1]);
        } else {
            let counter = this.bigram_counts.get(given_word);
            if (counter) next_words = Array.from(counter.keys());
        }
        if (next_words.length === 0) return '</s>';
        let probabilities = next_words.map(w => this.get_probability(w, given_word));
        return weightedRandom(next_words, probabilities);
    }
}

// --- å…¨å±€çŠ¶æ€ ---
let bigramModel = null;
let trigramModel = null;
let isTrained = false;
let sessionHistory = ['<s>']; 
let currentDOMContainer = null;

// --- ç•Œé¢é€»è¾‘ ---

function scrollToBottom() {
    const box = document.getElementById('consoleOutput');
    box.scrollTop = box.scrollHeight;
}

function updateCursor() {
    if (!currentDOMContainer) return;
    const oldCursor = document.querySelector('.text-cursor');
    if (oldCursor) oldCursor.remove();
    const cursor = document.createElement('span');
    cursor.className = 'text-cursor';
    currentDOMContainer.appendChild(cursor);
}

function ensureContainer() {
    const box = document.getElementById('consoleOutput');
    const isContinuous = document.getElementById('continuousMode').checked;
    
    const hasContent = Array.from(box.childNodes).some(n => 
        (n.nodeType === 1 && n.tagName !== 'DIV' && !n.classList?.contains('text-cursor')) || 
        (n.nodeType === 1 && n.tagName === 'DIV') 
    );
    
    if (!currentDOMContainer || (!isContinuous && hasContent)) {
        if (hasContent) {
            const oldCursor = document.querySelector('.text-cursor');
            if(oldCursor) oldCursor.remove();
            const divider = document.createElement('hr');
            divider.className = "topic-divider";
            box.appendChild(divider);
        } else {
            box.innerHTML = ''; 
        }
        currentDOMContainer = document.createElement('div');
        currentDOMContainer.style.display = "inline"; 
        sessionHistory = ['<s>'];
        box.appendChild(currentDOMContainer);
    }
}

function appendText(text, type) {
    if (!currentDOMContainer) ensureContainer();
    const span = document.createElement('span');
    span.innerText = text;
    if (type === 'user') span.className = 'text-user';
    else if (type === 'model') span.className = 'text-model';
    currentDOMContainer.appendChild(span);
}

function trainModels() {
    const text = document.getElementById('corpusInput').value;
    if (!text.trim()) { alert("è¯·è¾“å…¥è®­ç»ƒæ–‡æœ¬ï¼"); return; }
    // å¤„ç† Emoji
    let charList = ['<s>', ...Array.from(text), '</s>'];
    
    const statusEl = document.getElementById('trainStatus');
    statusEl.innerText = "è®­ç»ƒä¸­...";
    statusEl.style.color = "#f39c12";

    setTimeout(() => {
        try {
            bigramModel = new SimpleBigramLM(); bigramModel.train(charList);
            trigramModel = new SimpleTrigramLM(); trigramModel.train(charList);
            isTrained = true;
            statusEl.innerText = "å·²å°±ç»ª";
            statusEl.style.color = "#27ae60";
            
            const outBox = document.getElementById('consoleOutput');
            
            // å¦‚æœæ˜¯åˆå§‹çŠ¶æ€ï¼Œæ¸…ç©ºæ¬¢è¿è¯­
            if (outBox.innerText.includes("è¯·å…ˆç‚¹å‡»å·¦ä¾§")) {
                outBox.innerHTML = '<div style="color:gray; text-align:center; padding-top:20px;">è¾“å…¥æ–‡å­—å¼€å§‹æ¥é¾™...</div>';
            } else {
                // å¦‚æœæ˜¯é‡æ–°è®­ç»ƒï¼Œè¾“å‡ºåˆ†å‰²çº¿æç¤º
                const msg = document.createElement('div');
                msg.style.textAlign = 'center';
                msg.style.color = '#27ae60';
                msg.style.fontSize = '0.85rem';
                msg.style.margin = '15px 0';
                msg.style.borderTop = '1px dashed #444'; 
                msg.style.borderBottom = '1px dashed #444';
                msg.style.padding = '5px 0';
                msg.innerText = "--- æ¨¡å‹å·²æ›´æ–° / ä¸Šä¸‹æ–‡å·²é‡ç½® ---";
                outBox.appendChild(msg);
                outBox.scrollTop = outBox.scrollHeight;
            }

            // å…³é”®ï¼šé‡ç½®ä¸Šä¸‹æ–‡ï¼Œç¡®ä¿æ–°æ¨¡å‹ç«‹åˆ»ç”Ÿæ•ˆ
            sessionHistory = ['<s>'];
            currentDOMContainer = null;

        } catch (e) {
            alert("è®­ç»ƒå‡ºé”™ï¼š" + e.message);
            statusEl.innerText = "å‡ºé”™";
            statusEl.style.color = "red";
        }
    }, 10);
}

function getModel() {
    if (!isTrained) { alert("è¯·å…ˆç‚¹å‡»å·¦ä¾§è®­ç»ƒæ¨¡å‹ï¼"); return null; }
    return document.querySelector('input[name="modelType"]:checked').value === 'bigram' ? bigramModel : trigramModel;
}

function generateNextToken() {
    const model = getModel();
    if (!model) return null;
    let nextWord;
    try {
        if (model instanceof SimpleTrigramLM) {
            let context;
            if (sessionHistory.length >= 2) {
                context = [sessionHistory[sessionHistory.length-2], sessionHistory[sessionHistory.length-1]];
            } else {
                context = sessionHistory[sessionHistory.length-1];
            }
            nextWord = model.generate_word(context);
        } else {
            let context = sessionHistory[sessionHistory.length-1];
            nextWord = model.generate_word(context);
        }

        if (nextWord === '</s>') {
            nextWord = model.getRandomChar();
        }
        
    } catch(e) { 
        nextWord = model.getRandomChar(); 
    }
    return nextWord;
}

function triggerRandomGeneration() {
    if (!isTrained) { alert("è¯·å…ˆè®­ç»ƒæ¨¡å‹"); return; }
    ensureContainer();
    let count = parseInt(document.getElementById('aiCount').value);
    const length = (isNaN(count) || count < 1) ? 20 : count;

    for (let i = 0; i < length; i++) {
        let w = generateNextToken();
        sessionHistory.push(w);
        appendText(w, 'model');
    }
    updateCursor();
    scrollToBottom();
}

function processInput() {
    if (!isTrained) { alert("è¯·å…ˆè®­ç»ƒæ¨¡å‹"); return; }

    const inputEl = document.getElementById('userCharInput');
    const val = inputEl.value;
    if (!val) return;

    let aiCount = parseInt(document.getElementById('aiCount').value);
    if (isNaN(aiCount) || aiCount < 1) aiCount = 1;

    ensureContainer();

    const chars = Array.from(val);
    chars.forEach(c => {
        sessionHistory.push(c);
        appendText(c, 'user');
    });

    for (let i = 0; i < aiCount; i++) {
        let nextW = generateNextToken();
        sessionHistory.push(nextW);
        appendText(nextW, 'model');
    }

    updateCursor();
    scrollToBottom();

    inputEl.value = '';
    inputEl.focus();
    inputEl.style.height = 'auto';
    inputEl.style.height = inputEl.scrollHeight + 'px';
}

document.getElementById('userCharInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        if (e.ctrlKey || e.metaKey) {
            e.preventDefault();
            const start = this.selectionStart;
            const end = this.selectionEnd;
            const value = this.value;
            this.value = value.substring(0, start) + "\n" + value.substring(end);
            this.selectionStart = this.selectionEnd = start + 1;
            this.dispatchEvent(new Event('input')); 
        } else {
            e.preventDefault(); 
            processInput();
        }
    }
});

function focusInputIfEmptySelection() {
    const selection = window.getSelection();
    if (selection.toString().length === 0) {
        document.getElementById('userCharInput').focus();
    }
}

</script>

</body>
</html>