<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N-Gram æ–‡è‰ºå¤å…´</title>
    <style>
        /* 1. åŸºç¡€å¸ƒå±€ï¼šå…è®¸é¡µé¢æ»šåŠ¨ï¼Œæ”¯æŒ Emoji å­—ä½“ */
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji", sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 20px;
            color: #333;
            /* ç§»é™¤ height: 100vh å’Œ overflow: hiddenï¼Œè®©é¡µé¢è‡ªç„¶æ»šåŠ¨ */
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            width: 100%;
            margin: 0 auto;
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            box-sizing: border-box;
            /* ç§»é™¤ flex-grow ç­‰å¼ºåˆ¶æ’‘æ»¡å±å¹•çš„å±æ€§ */
        }
        
        h1 { 
            margin: 0 0 20px 0; 
            text-align: center; 
            color: #2c3e50; 
            font-size: 1.8rem; 
            font-family: "Microsoft YaHei", "Songti SC", serif;
            font-weight: bold;
            letter-spacing: 2px;
        }
        
        /* é¡¶éƒ¨æ§åˆ¶æ  */
        .top-controls {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            margin-bottom: 20px;
        }

        .training-section {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .control-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            justify-content: space-between;
        }
        
        .control-left, .control-right {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        /* 2. è‡ªé€‚åº”é«˜åº¦æ–‡æœ¬åŸŸ (è¯­æ–™æ¡†) */
        textarea.auto-expand {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.95rem;
            box-sizing: border-box;
            margin-bottom: 5px;
            font-family: inherit;
            resize: none; /* ç¦æ­¢æ‰‹åŠ¨æ‹–æ‹½ï¼Œäº¤ç”± JS æ§åˆ¶ */
            overflow-y: hidden; /* é»˜è®¤éšè—æ»šåŠ¨æ¡ï¼Œè¶…å‡º max-height åç”± JS/CSS åˆ‡æ¢ */
            min-height: 60px;   /* çº¦ 2 è¡Œ */
            max-height: 500px;  /* é™åˆ¶æœ€å¤§é«˜åº¦çº¦ 20 è¡Œ */
            transition: border-color 0.2s;
            line-height: 1.5;
        }
        textarea.auto-expand:focus {
            border-color: #3498db;
            outline: none;
        }

        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        button:hover { background-color: #2980b9; }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        button.action-btn { background-color: #27ae60; }
        button.action-btn:hover { background-color: #219150; }

        .switch-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
            font-weight: bold;
            color: #2c3e50;
            font-size: 0.9rem;
        }
        .switch-label input { margin-right: 6px; transform: scale(1.2); }

        .setting-group {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
            background: #fff;
            padding: 4px 8px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
        }
        .setting-group input[type="number"] {
            width: 45px;
            padding: 3px;
            border: none;
            border-bottom: 1px solid #bdc3c7;
            text-align: center;
            font-size: 0.9rem;
            outline: none;
        }

        /* 3. è¾“å‡ºåŒºåŸŸï¼šé«˜åº¦é™åˆ¶ä¸æ»šåŠ¨ */
        .output-wrapper {
            /* ç§»é™¤ flex-growï¼Œæ”¹ä¸ºè‡ªé€‚åº”å— */
            width: 100%;
            margin-bottom: 20px;
            border: 2px solid #b2bec3;
            border-radius: 6px;
            background-color: #2d3436;
            position: relative;
        }

        .output-box {
            width: 100%;
            box-sizing: border-box;
            padding: 20px;
            color: #dfe6e9;
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.1rem;
            line-height: 1.8;
            white-space: pre-wrap;
            word-break: break-all;
            
            /* é«˜åº¦æ§åˆ¶æ ¸å¿ƒ */
            min-height: 200px;
            max-height: 600px; /* çº¦ç­‰äº 20 è¡Œæ–‡æœ¬çš„é«˜åº¦ */
            overflow-y: auto;  /* å†…å®¹è¶…å‡ºæ—¶æ˜¾ç¤ºå‚ç›´æ»šåŠ¨æ¡ */
            
            /* å…³é”®ï¼šå…è®¸æ–‡æœ¬é€‰æ‹©ä¸å³é”® */
            user-select: text; 
            cursor: text;
        }

        .text-user { color: #ff7675; font-weight: bold; }
        .text-model { color: #55efc4; }
        
        .text-cursor {
            display: inline-block;
            width: 8px;
            height: 1.2rem;
            background-color: #dfe6e9;
            animation: blink 1s infinite;
            vertical-align: middle;
            margin-left: 2px;
        }
        @keyframes blink { 50% { opacity: 0; } }

        .topic-divider {
            border: 0;
            height: 1px;
            background-image: linear-gradient(to right, rgba(0, 0, 0, 0), rgba(255, 255, 255, 0.5), rgba(0, 0, 0, 0));
            margin: 20px 0;
            position: relative;
            display: block; 
            width: 100%;
        }
        .topic-divider::after {
            content: "æ–°è¯é¢˜";
            position: absolute;
            left: 50%;
            top: -10px;
            transform: translateX(-50%);
            background: #2d3436;
            padding: 0 10px;
            color: #b2bec3;
            font-size: 0.8rem;
        }

        /* 4. åº•éƒ¨è¾“å…¥æ  */
        .input-area {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            align-items: flex-end; /* åº•éƒ¨å¯¹é½ï¼Œé˜²æ­¢æŒ‰é’®éšæ–‡æœ¬æ¡†æ‹‰ä¼¸å˜å½¢ */
            gap: 10px;
            border: 1px solid #bdc3c7;
        }
        
        /* è¾“å…¥æ¡†ç‰¹å®šæ ·å¼ */
        .input-area textarea.auto-expand {
            margin-bottom: 0;
            border: 2px solid #bdc3c7;
            background: white;
            min-height: 48px; /* åˆå§‹é«˜åº¦ç¨å¤§ä¸€ç‚¹ */
        }
        .input-area textarea.auto-expand:focus {
            border-color: #3498db;
        }

        .status-bar {
            text-align: right;
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-top: 8px;
            display: flex;
            justify-content: space-between;
        }
        
        /* æ»šåŠ¨æ¡ç¾åŒ– (Webkit) */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.4); }
        /* è¾“å‡ºæ¡†æ·±è‰²æ¨¡å¼æ»šåŠ¨æ¡ */
        .output-box::-webkit-scrollbar-track { background: #2d3436; }
        .output-box::-webkit-scrollbar-thumb { background: #636e72; }
    </style>
</head>
<body>

<div class="container">
    <h1>N-Gram æ–‡è‰ºå¤å…´</h1>
    
    <!-- æ§åˆ¶åŒº -->
    <div class="top-controls">
        <!-- è®­ç»ƒè¡Œ -->
        <div class="training-section">
            <label style="font-weight:bold; color:#2c3e50; display:block; margin-bottom:5px;">ğŸ“‚ è®­ç»ƒè¯­æ–™è®¾ç½®:</label>
            <div style="display:flex; gap:10px; align-items: flex-start;">
                <!-- è¯­æ–™è¾“å…¥æ¡†ï¼šåº”ç”¨ auto-expand ç±» -->
                <textarea id="corpusInput" class="auto-expand" rows="1" placeholder="åœ¨æ­¤ç²˜è´´è¯­æ–™...">
æ˜¥å¤©åˆ°äº†ï¼Œä¸‡ç‰©å¤è‹ã€‚å°è‰ä»åœŸé‡Œæ¢å‡ºå¤´æ¥ï¼ŒèŠ±å„¿åœ¨é£ä¸­è·³èˆã€‚ğŸŒ¸
ç‡•å­ä»å—æ–¹é£å›æ¥äº†ï¼Œå®ƒä»¬åœ¨å±‹æªä¸‹ç­‘å·¢ã€‚ğŸ¦
æ²³æ°´è§£å†»äº†ï¼Œå®å®å’šå’šåœ°æµå‘è¿œæ–¹ã€‚ğŸŒŠ
å°æœ‹å‹ä»¬è„±ä¸‹åšåšçš„æ£‰è¢„ï¼Œåœ¨è‰åœ°ä¸Šå¥”è·‘ï¼Œæ”¾é£ç­ã€‚ğŸª
æˆ‘ä¹Ÿæƒ³å»éƒŠæ¸¸ï¼Œçœ‹çœ‹è¿™ç¾ä¸½çš„æ˜¥å¤©ã€‚
Biology is the study of life. The cell is the basic unit of life. ğŸ§¬
                </textarea>
                <div style="display:flex; flex-direction:column; gap:8px;">
                    <button onclick="trainModels()">ğŸš€ è®­ç»ƒæ¨¡å‹</button>
                    <div id="trainStatus" style="text-align:center; font-size:0.8rem; color:#e74c3c;">æœªè®­ç»ƒ</div>
                </div>
            </div>
        </div>
        
        <!-- æ“ä½œè¡Œ -->
        <div class="control-row">
            <div class="control-left">
                <div>
                    <strong>æ¨¡å‹:</strong>
                    <input type="radio" id="modelBigram" name="modelType" value="bigram" checked> <label for="modelBigram">Bigram</label>
                    <input type="radio" id="modelTrigram" name="modelType" value="trigram"> <label for="modelTrigram">Trigram</label>
                </div>
                
                <div style="border-left: 1px solid #ccc; padding-left: 15px;">
                    <label class="switch-label" title="å¼€å¯åï¼Œæ–°ç”Ÿæˆçš„å†…å®¹å°†ç›´æ¥æ¥åœ¨ä¸Šä¸€æ®µæ–‡å­—åé¢">
                        <input type="checkbox" id="continuousMode" checked> ğŸ”— å»¶ç»­ä¸Šæ–‡
                    </label>
                </div>
            </div>

            <div class="control-right">
                <div class="setting-group" title="è®¾ç½®AIæ¥é¾™æ—¶æ¯æ¬¡ç”Ÿæˆçš„å­—æ•°">
                    <label for="aiCount">AIå­—æ•°:</label>
                    <input type="number" id="aiCount" value="1" min="1" max="100">
                </div>
                <button class="action-btn" onclick="triggerRandomGeneration()">ğŸ² éšæœºç”Ÿæˆä¸€æ®µ</button>
            </div>
        </div>
    </div>

    <!-- è¾“å‡ºå±å¹• -->
    <div class="output-wrapper">
        <!-- æ³¨æ„ï¼šclickèšç„¦ç”±JSå¤„ç†ï¼Œé¿å…å¹²æ‰°é€‰ä¸­æ–‡æœ¬ -->
        <div id="consoleOutput" class="output-box">
            <div style="color:#b2bec3; text-align:center; padding-top:40px; font-style:italic;">
                è¯·å…ˆç‚¹å‡»â€œè®­ç»ƒæ¨¡å‹â€ï¼Œç„¶ååœ¨æ­¤å¤„å¼€å§‹åˆ›ä½œ...
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨è¾“å…¥æ  -->
    <div class="input-area">
        <!-- ç”¨æˆ·è¾“å…¥æ¡†ï¼šåº”ç”¨ auto-expand ç±» -->
        <textarea id="userCharInput" class="auto-expand" placeholder="è¾“å…¥æ–‡å­— (Enterå‘é€ï¼ŒCtrl+Enteræ¢è¡Œ)..."></textarea>
        <button onclick="processInput()" style="padding:10px 25px; font-weight:bold; height:48px;">å‘é€</button>
    </div>
    
    <div class="status-bar">
        <span>âŒ¨ï¸ å¿«æ·é”®: Enter å‘é€ / Ctrl+Enter æ¢è¡Œ</span>
        <span><span style="color:#ff7675;">â–  ç”¨æˆ·</span> / <span style="color:#55efc4;">â–  AI</span></span>
    </div>
</div>

<script>
// --- JS 1. è‡ªé€‚åº”é«˜åº¦é€»è¾‘ (Auto-Resize) ---
function initAutoResize() {
    const textareas = document.querySelectorAll('textarea.auto-expand');
    
    function resize(el) {
        // é‡ç½®é«˜åº¦ä»¥è·å¾—æ­£ç¡®çš„ scrollHeight (å¤„ç†ç¼©å‡çš„æƒ…å†µ)
        el.style.height = 'auto'; 
        
        // è®¾ç½®æ–°é«˜åº¦ï¼Œä½†ä¸è¶…è¿‡ max-height (CSSä¸­è®¾ç½®)
        // è¿™é‡Œçš„ 500 æ˜¯ç¡¬ç¼–ç çš„ä¸Šé™ï¼ŒCSS ä¸­å·²è®¾ç½® max-height æ§åˆ¶ UIï¼Œ
        // JS åªè¦è®¾ç½®è¶³å¤Ÿå¤§ï¼ŒCSS çš„ overflow å°±ä¼šç”Ÿæ•ˆ
        const newHeight = Math.min(el.scrollHeight, 500); 
        
        // å¦‚æœå†…å®¹å¾ˆå°‘ï¼Œä¿æŒ min-height (CSSæ§åˆ¶)
        el.style.height = el.scrollHeight + 'px';
        
        // å¦‚æœè¾¾åˆ°æœ€å¤§é«˜åº¦ï¼Œæ˜¾ç¤ºæ»šåŠ¨æ¡
        if (el.scrollHeight > 500) {
            el.style.overflowY = "auto";
        } else {
            el.style.overflowY = "hidden";
        }
    }

    textareas.forEach(el => {
        // åˆå§‹åŒ–è°ƒæ•´
        resize(el);
        // è¾“å…¥æ—¶è°ƒæ•´
        el.addEventListener('input', () => resize(el));
        // çª—å£å¤§å°æ”¹å˜æ—¶è°ƒæ•´
        window.addEventListener('resize', () => resize(el));
    });
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
window.addEventListener('DOMContentLoaded', initAutoResize);


// --- N-Gram ç®—æ³•æ ¸å¿ƒ ---
class Counter extends Map {
    get(key) { return super.get(key) || 0; }
    add(key, val = 1) { this.set(key, this.get(key) + val); }
}

function weightedRandom(choices, weights) {
    let total = weights.reduce((a, b) => a + b, 0);
    let randomVal = Math.random() * total;
    let cumulative = 0;
    for (let i = 0; i < choices.length; i++) {
        cumulative += weights[i];
        if (randomVal < cumulative) return choices[i];
    }
    return choices[choices.length - 1]; 
}

class SimpleNGramLMBase {
    constructor() {
        this.vocab = new Set();
        this.unigram_counts = new Counter();
        this.bigram_counts = new Map(); 
        this.trigram_counts = new Map();
        this.smoothing = 1.0;
        this.vocab_size = 0;
    }
    get_bigram_count(w1, w2) {
        if (!this.bigram_counts.has(w1)) return 0;
        return this.bigram_counts.get(w1).get(w2);
    }
    get_trigram_count(w1, w2, w3) {
        let key = w1 + "|" + w2;
        if (!this.trigram_counts.has(key)) return 0;
        return this.trigram_counts.get(key).get(w3);
    }
    getRandomChar() {
        // è¿‡æ»¤æ‰æ ‡è®°ç¬¦ï¼Œéšæœºé€‰å­—
        let validChars = Array.from(this.vocab).filter(c => c !== '<s>' && c !== '</s>');
        if (validChars.length === 0) return ' '; 
        return validChars[Math.floor(Math.random() * validChars.length)];
    }
}

class SimpleBigramLM extends SimpleNGramLMBase {
    train(corpus) {
        for (let i = 0; i < corpus.length; i++) {
            let word = corpus[i];
            this.vocab.add(word);
            this.unigram_counts.add(word);
            if (i < corpus.length - 1) {
                let next_word = corpus[i+1];
                if (!this.bigram_counts.has(word)) this.bigram_counts.set(word, new Counter());
                this.bigram_counts.get(word).add(next_word);
            }
        }
        this.vocab_size = this.vocab.size;
    }
    get_probability(word, given_word) {
        let bigram_c = this.get_bigram_count(given_word, word) + this.smoothing;
        let unigram_c = this.unigram_counts.get(given_word) + this.smoothing * this.vocab_size;
        return bigram_c / unigram_c;
    }
    generate_word(given_word) {
        let next_counter = this.bigram_counts.get(given_word);
        let next_words = next_counter ? Array.from(next_counter.keys()) : [];
        if (next_words.length === 0) return '</s>';
        let probabilities = next_words.map(w => this.get_probability(w, given_word));
        return weightedRandom(next_words, probabilities); 
    }
}

class SimpleTrigramLM extends SimpleNGramLMBase {
    train(corpus) {
        for (let i = 0; i < corpus.length; i++) {
            let word = corpus[i];
            this.vocab.add(word);
            this.unigram_counts.add(word);
            if (i < corpus.length - 1) {
                let next_word = corpus[i+1];
                if (!this.bigram_counts.has(word)) this.bigram_counts.set(word, new Counter());
                this.bigram_counts.get(word).add(next_word);
            }
            if (i < corpus.length - 2) {
                let next_word = corpus[i+1];
                let next_next_word = corpus[i+2];
                let bigram_key = word + "|" + next_word;
                if (!this.trigram_counts.has(bigram_key)) this.trigram_counts.set(bigram_key, new Counter());
                this.trigram_counts.get(bigram_key).add(next_next_word);
            }
        }
        this.vocab_size = this.vocab.size;
    }
    get_probability(word, given_word) {
        if (Array.isArray(given_word) && given_word.length === 2) {
            let [w1, w2] = given_word;
            let trigram_c = this.get_trigram_count(w1, w2, word) + this.smoothing;
            let bigram_c = this.get_bigram_count(w1, w2) + this.smoothing * this.vocab_size;
            return trigram_c / bigram_c;
        } else {
            let bg_count = this.get_bigram_count(given_word, word) + this.smoothing;
            let ug_count = this.unigram_counts.get(given_word) + this.smoothing * this.vocab_size;
            return bg_count / ug_count;
        }
    }
    generate_word(given_word) {
        let next_words = [];
        if (Array.isArray(given_word) && given_word.length === 2) {
            let key = given_word[0] + "|" + given_word[1];
            let counter = this.trigram_counts.get(key);
            if (counter) next_words = Array.from(counter.keys());
            else return this.generate_word(given_word[1]);
        } else {
            let counter = this.bigram_counts.get(given_word);
            if (counter) next_words = Array.from(counter.keys());
        }
        if (next_words.length === 0) return '</s>';
        let probabilities = next_words.map(w => this.get_probability(w, given_word));
        return weightedRandom(next_words, probabilities);
    }
}

// --- å…¨å±€çŠ¶æ€ ---
let bigramModel = null;
let trigramModel = null;
let isTrained = false;
let sessionHistory = ['<s>']; 
let currentDOMContainer = null;

// --- ç•Œé¢é€»è¾‘ ---

function scrollToBottom() {
    const box = document.getElementById('consoleOutput');
    box.scrollTop = box.scrollHeight;
}

function updateCursor() {
    if (!currentDOMContainer) return;
    const oldCursor = document.querySelector('.text-cursor');
    if (oldCursor) oldCursor.remove();
    const cursor = document.createElement('span');
    cursor.className = 'text-cursor';
    currentDOMContainer.appendChild(cursor);
}

function ensureContainer() {
    const box = document.getElementById('consoleOutput');
    const isContinuous = document.getElementById('continuousMode').checked;
    
    // æ£€æŸ¥æ˜¯å¦æœ‰å†…å®¹èŠ‚ç‚¹ï¼ˆå¿½ç•¥ç©ºç™½æ–‡æœ¬èŠ‚ç‚¹ï¼‰
    const hasContent = Array.from(box.childNodes).some(n => 
        (n.nodeType === 1 && n.tagName !== 'DIV' && !n.classList?.contains('text-cursor')) || 
        (n.nodeType === 1 && n.tagName === 'DIV') 
    );
    
    if (!currentDOMContainer || (!isContinuous && hasContent)) {
        if (hasContent) {
            const oldCursor = document.querySelector('.text-cursor');
            if(oldCursor) oldCursor.remove();
            const divider = document.createElement('hr');
            divider.className = "topic-divider";
            box.appendChild(divider);
        } else {
            box.innerHTML = ''; 
        }
        currentDOMContainer = document.createElement('div');
        // ä¸ºæ–°å®¹å™¨ä¿ç•™æ ·å¼ï¼Œç¡®ä¿è¡Œé«˜
        currentDOMContainer.style.display = "inline"; 
        sessionHistory = ['<s>'];
        box.appendChild(currentDOMContainer);
    }
}

function appendText(text, type) {
    if (!currentDOMContainer) ensureContainer();
    const span = document.createElement('span');
    span.innerText = text;
    if (type === 'user') span.className = 'text-user';
    else if (type === 'model') span.className = 'text-model';
    currentDOMContainer.appendChild(span);
}

function trainModels() {
    const text = document.getElementById('corpusInput').value;
    if (!text.trim()) { alert("è¯·è¾“å…¥è®­ç»ƒæ–‡æœ¬ï¼"); return; }
    // ä½¿ç”¨ Array.from ç¡®ä¿æ­£ç¡®å¤„ç† emoji (å®ƒä»¬ç”± surrogate pairs ç»„æˆ)
    let charList = ['<s>', ...Array.from(text), '</s>'];
    
    setTimeout(() => {
        try {
            bigramModel = new SimpleBigramLM(); bigramModel.train(charList);
            trigramModel = new SimpleTrigramLM(); trigramModel.train(charList);
            isTrained = true;
            const statusEl = document.getElementById('trainStatus');
            statusEl.innerText = "âœ… æ¨¡å‹å·²å°±ç»ª";
            statusEl.style.color = "#27ae60";
            statusEl.style.fontWeight = "bold";
            document.getElementById('consoleOutput').innerHTML = '<div style="color:gray; text-align:center; padding-top:20px;">æ¨¡å‹å·²åŠ è½½ï¼Œè¾“å…¥æ–‡å­—å¼€å§‹æ¥é¾™...</div>';
            currentDOMContainer = null; 
        } catch (e) {
            alert("è®­ç»ƒå‡ºé”™ï¼š" + e.message);
        }
    }, 10);
}

function getModel() {
    if (!isTrained) { alert("è¯·å…ˆç‚¹å‡»è®­ç»ƒæ¨¡å‹ï¼"); return null; }
    return document.querySelector('input[name="modelType"]:checked').value === 'bigram' ? bigramModel : trigramModel;
}

function generateNextToken() {
    const model = getModel();
    if (!model) return null;
    let nextWord;
    try {
        if (model instanceof SimpleTrigramLM) {
            let context;
            if (sessionHistory.length >= 2) {
                context = [sessionHistory[sessionHistory.length-2], sessionHistory[sessionHistory.length-1]];
            } else {
                context = sessionHistory[sessionHistory.length-1];
            }
            nextWord = model.generate_word(context);
        } else {
            let context = sessionHistory[sessionHistory.length-1];
            nextWord = model.generate_word(context);
        }

        if (nextWord === '</s>') {
            nextWord = model.getRandomChar();
        }
        
    } catch(e) { 
        nextWord = model.getRandomChar(); 
    }
    return nextWord;
}

function triggerRandomGeneration() {
    if (!isTrained) { alert("è¯·å…ˆè®­ç»ƒæ¨¡å‹"); return; }
    ensureContainer();
    const length = 20; 
    for (let i = 0; i < length; i++) {
        let w = generateNextToken();
        sessionHistory.push(w);
        appendText(w, 'model');
    }
    updateCursor();
    scrollToBottom();
}

function processInput() {
    if (!isTrained) { alert("è¯·å…ˆè®­ç»ƒæ¨¡å‹"); return; }

    const inputEl = document.getElementById('userCharInput');
    const val = inputEl.value;
    if (!val) return;

    let aiCount = parseInt(document.getElementById('aiCount').value);
    if (isNaN(aiCount) || aiCount < 1) aiCount = 1;

    ensureContainer();

    // 1. ä¸Šå±ç”¨æˆ·è¾“å…¥ (ä½¿ç”¨ Array.from å¤„ç† emoji)
    const chars = Array.from(val);
    chars.forEach(c => {
        sessionHistory.push(c);
        appendText(c, 'user');
    });

    // 2. ç”Ÿæˆ AI å›å¤
    for (let i = 0; i < aiCount; i++) {
        let nextW = generateNextToken();
        sessionHistory.push(nextW);
        appendText(nextW, 'model');
    }

    updateCursor();
    scrollToBottom();

    inputEl.value = '';
    inputEl.focus();
    
    // è§¦å‘ä¸€ä¸‹è¾“å…¥æ¡†çš„é«˜åº¦é‡ç½®
    inputEl.style.height = 'auto'; 
    inputEl.style.height = inputEl.scrollHeight + 'px';
}

// é”®ç›˜ç›‘å¬
document.getElementById('userCharInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        if (e.ctrlKey || e.metaKey) {
            e.preventDefault();
            const start = this.selectionStart;
            const end = this.selectionEnd;
            const value = this.value;
            this.value = value.substring(0, start) + "\n" + value.substring(end);
            this.selectionStart = this.selectionEnd = start + 1;
            // è§¦å‘é«˜åº¦è°ƒæ•´
            this.dispatchEvent(new Event('input'));
        } else {
            e.preventDefault(); 
            processInput();
        }
    }
});

// ç‚¹å‡» Output æ¡†æ—¶è®©è¾“å…¥æ¡†èšç„¦ï¼Œä½†è¦åˆ¤æ–­æ˜¯å¦é€‰ä¸­äº†æ–‡å­—
document.getElementById('consoleOutput').addEventListener('click', function(e) {
    const selection = window.getSelection();
    // å¦‚æœæ²¡æœ‰é€‰ä¸­æ–‡æœ¬ï¼Œæ‰èšç„¦è¾“å…¥æ¡†ï¼Œæ–¹ä¾¿ç”¨æˆ·è¿›è¡Œå¤åˆ¶æ“ä½œ
    if (selection.toString().length === 0) {
        document.getElementById('userCharInput').focus();
    }
});

</script>

</body>
</html>