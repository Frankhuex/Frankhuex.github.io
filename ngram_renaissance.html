<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N-Gram æ–‡è‰ºå¤å…´</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 10px;
            color: #333;
            height: 100vh;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }
        .container {
            max-width: 900px;
            width: 100%;
            margin: 0 auto;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            overflow: hidden;
        }
        
        /* æ ‡é¢˜æ ·å¼ */
        h1 { 
            margin: 0 0 10px 0; 
            text-align: center; 
            color: #2c3e50; 
            font-size: 1.6rem; 
            font-family: "Microsoft YaHei", "Songti SC", serif; /* æ–‡è‰ºä¸€ç‚¹çš„å­—ä½“ */
            font-weight: bold;
            letter-spacing: 2px;
        }
        
        /* é¡¶éƒ¨æ§åˆ¶æ  */
        .top-controls {
            flex-shrink: 0;
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            margin-bottom: 10px;
        }

        .training-section {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .control-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            justify-content: space-between; /* ä¸¤ç«¯å¯¹é½å¸ƒå±€ */
        }
        
        .control-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .control-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* æ–‡æœ¬åŸŸé€šç”¨æ ·å¼ */
        textarea.corpus-area {
            width: 100%;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            resize: vertical;
            font-size: 0.9rem;
            box-sizing: border-box;
            margin-bottom: 5px;
            font-family: inherit;
        }

        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        button:hover { background-color: #2980b9; }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        
        button.action-btn { background-color: #27ae60; }
        button.action-btn:hover { background-color: #219150; }

        .switch-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
            font-weight: bold;
            color: #2c3e50;
            font-size: 0.9rem;
        }
        .switch-label input { margin-right: 6px; transform: scale(1.2); }

        /* å­—æ•°è®¾ç½®æ ·å¼ */
        .setting-group {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
            background: #fff;
            padding: 4px 8px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
        }
        .setting-group input[type="number"] {
            width: 45px;
            padding: 3px;
            border: none;
            border-bottom: 1px solid #bdc3c7;
            text-align: center;
            font-size: 0.9rem;
            outline: none;
        }

        /* è¾“å‡ºåŒºåŸŸ */
        .output-wrapper {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            border: 2px solid #b2bec3;
            border-radius: 6px;
            background-color: #2d3436;
            overflow: hidden;
            position: relative;
        }

        .output-box {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            color: #dfe6e9;
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.1rem;
            line-height: 1.8;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .text-user { color: #ff7675; font-weight: bold; }
        .text-model { color: #55efc4; }
        
        /* å…‰æ ‡ */
        .text-cursor {
            display: inline-block;
            width: 8px;
            height: 1.2rem;
            background-color: #dfe6e9;
            animation: blink 1s infinite;
            vertical-align: middle;
            margin-left: 2px;
        }
        @keyframes blink { 50% { opacity: 0; } }

        /* åˆ†å‰²çº¿æ ·å¼ */
        .topic-divider {
            border: 0;
            height: 1px;
            background-image: linear-gradient(to right, rgba(0, 0, 0, 0), rgba(255, 255, 255, 0.5), rgba(0, 0, 0, 0));
            margin: 20px 0;
            position: relative;
            display: block; 
            width: 100%;
        }
        .topic-divider::after {
            content: "æ–°è¯é¢˜";
            position: absolute;
            left: 50%;
            top: -10px;
            transform: translateX(-50%);
            background: #2d3436;
            padding: 0 10px;
            color: #b2bec3;
            font-size: 0.8rem;
        }

        /* åº•éƒ¨è¾“å…¥æ  */
        .input-area {
            flex-shrink: 0;
            margin-top: 10px;
            display: flex;
            gap: 10px;
            align-items: flex-end; /* åº•éƒ¨å¯¹é½ï¼Œé€‚åº”å¤šè¡Œæ–‡æœ¬æ¡† */
            background: #ecf0f1;
            padding: 10px;
            border-radius: 8px;
        }
        /* å°† input æ”¹ä¸º textarea æ ·å¼ */
        .input-area textarea {
            flex-grow: 1;
            padding: 10px;
            border: 2px solid #bdc3c7;
            border-radius: 6px;
            font-size: 1rem;
            outline: none;
            resize: none; /* ç¦æ­¢æ‰‹åŠ¨è°ƒæ•´å¤§å°ï¼Œç”±JSæˆ–å›ºå®šé«˜åº¦æ§åˆ¶ */
            height: 45px; /* åˆå§‹é«˜åº¦ */
            font-family: inherit;
            line-height: 1.4;
        }
        .input-area textarea:focus { border-color: #3498db; }

        .status-bar {
            text-align: right;
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-top: 5px;
            display: flex;
            justify-content: space-between;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>N-Gram æ–‡è‰ºå¤å…´</h1>
    
    <!-- æ§åˆ¶åŒº -->
    <div class="top-controls">
        <!-- è®­ç»ƒè¡Œ -->
        <div class="training-section">
            <label style="font-weight:bold; color:#2c3e50; display:block; margin-bottom:5px;">ğŸ“‚ è®­ç»ƒè¯­æ–™è®¾ç½®:</label>
            <div style="display:flex; gap:10px;">
                <textarea id="corpusInput" class="corpus-area" rows="2">
æ˜¥å¤©åˆ°äº†ï¼Œä¸‡ç‰©å¤è‹ã€‚å°è‰ä»åœŸé‡Œæ¢å‡ºå¤´æ¥ï¼ŒèŠ±å„¿åœ¨é£ä¸­è·³èˆã€‚
ç‡•å­ä»å—æ–¹é£å›æ¥äº†ï¼Œå®ƒä»¬åœ¨å±‹æªä¸‹ç­‘å·¢ã€‚
æ²³æ°´è§£å†»äº†ï¼Œå®å®å’šå’šåœ°æµå‘è¿œæ–¹ã€‚
å°æœ‹å‹ä»¬è„±ä¸‹åšåšçš„æ£‰è¢„ï¼Œåœ¨è‰åœ°ä¸Šå¥”è·‘ï¼Œæ”¾é£ç­ã€‚
æˆ‘ä¹Ÿæƒ³å»éƒŠæ¸¸ï¼Œçœ‹çœ‹è¿™ç¾ä¸½çš„æ˜¥å¤©ã€‚
Biology is the study of life. The cell is the basic unit of life.
                </textarea>
                <div style="display:flex; flex-direction:column; justify-content:center; gap:5px;">
                    <button onclick="trainModels()">ğŸš€ è®­ç»ƒæ¨¡å‹</button>
                    <div id="trainStatus" style="text-align:center; font-size:0.8rem; color:#e74c3c;">æœªè®­ç»ƒ</div>
                </div>
            </div>
        </div>
        
        <!-- æ“ä½œè¡Œ -->
        <div class="control-row">
            <!-- å·¦ä¾§ï¼šæ¨¡å‹é€‰æ‹©ä¸å¼€å…³ -->
            <div class="control-left">
                <div>
                    <strong>æ¨¡å‹:</strong>
                    <input type="radio" id="modelBigram" name="modelType" value="bigram" checked> <label for="modelBigram">Bigram</label>
                    <input type="radio" id="modelTrigram" name="modelType" value="trigram"> <label for="modelTrigram">Trigram</label>
                </div>
                
                <div style="border-left: 1px solid #ccc; padding-left: 15px;">
                    <label class="switch-label" title="å¼€å¯åï¼Œæ–°ç”Ÿæˆçš„å†…å®¹å°†ç›´æ¥æ¥åœ¨ä¸Šä¸€æ®µæ–‡å­—åé¢">
                        <input type="checkbox" id="continuousMode" checked> ğŸ”— å»¶ç»­ä¸Šæ–‡
                    </label>
                </div>
            </div>

            <!-- å³ä¾§ï¼šç”Ÿæˆæ§åˆ¶ -->
            <div class="control-right">
                <div class="setting-group" title="è®¾ç½®AIæ¥é¾™æ—¶æ¯æ¬¡ç”Ÿæˆçš„å­—æ•°">
                    <label for="aiCount">AIå­—æ•°:</label>
                    <input type="number" id="aiCount" value="1" min="1" max="100">
                </div>
                <button class="action-btn" onclick="triggerRandomGeneration()">ğŸ² éšæœºç”Ÿæˆä¸€æ®µ</button>
            </div>
        </div>
    </div>

    <!-- è¾“å‡ºå±å¹• -->
    <div class="output-wrapper" onclick="document.getElementById('userCharInput').focus()">
        <div id="consoleOutput" class="output-box">
            <div style="color:#b2bec3; text-align:center; margin-top:50px; font-style:italic;">
                è¯·å…ˆç‚¹å‡»â€œè®­ç»ƒæ¨¡å‹â€ï¼Œç„¶ååœ¨æ­¤å¤„å¼€å§‹åˆ›ä½œ...
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨è¾“å…¥æ  -->
    <div class="input-area">
        <!-- æ”¹ä¸º textarea ä»¥æ”¯æŒæ¢è¡Œ -->
        <textarea id="userCharInput" placeholder="è¾“å…¥æ–‡å­— (Enterå‘é€ï¼ŒCtrl+Enteræ¢è¡Œ)..."></textarea>
        <button onclick="processInput()" style="padding:10px 25px; font-weight:bold; height:45px;">å‘é€</button>
    </div>
    
    <div class="status-bar">
        <span>âŒ¨ï¸ å¿«æ·é”®: Enter å‘é€ / Ctrl+Enter æ¢è¡Œ</span>
        <span><span style="color:#ff7675;">â–  ç”¨æˆ·</span> / <span style="color:#55efc4;">â–  AI</span></span>
    </div>
</div>

<script>
// --- N-Gram ç®—æ³•æ ¸å¿ƒ (ä¿æŒä¸å˜) ---
class Counter extends Map {
    get(key) { return super.get(key) || 0; }
    add(key, val = 1) { this.set(key, this.get(key) + val); }
}

function weightedRandom(choices, weights) {
    let total = weights.reduce((a, b) => a + b, 0);
    let randomVal = Math.random() * total;
    let cumulative = 0;
    for (let i = 0; i < choices.length; i++) {
        cumulative += weights[i];
        if (randomVal < cumulative) return choices[i];
    }
    return choices[choices.length - 1]; 
}

class SimpleNGramLMBase {
    constructor() {
        this.vocab = new Set();
        this.unigram_counts = new Counter();
        this.bigram_counts = new Map(); 
        this.trigram_counts = new Map();
        this.smoothing = 1.0;
        this.vocab_size = 0;
    }
    get_bigram_count(w1, w2) {
        if (!this.bigram_counts.has(w1)) return 0;
        return this.bigram_counts.get(w1).get(w2);
    }
    get_trigram_count(w1, w2, w3) {
        let key = w1 + "|" + w2;
        if (!this.trigram_counts.has(key)) return 0;
        return this.trigram_counts.get(key).get(w3);
    }
}

class SimpleBigramLM extends SimpleNGramLMBase {
    train(corpus) {
        for (let i = 0; i < corpus.length; i++) {
            let word = corpus[i];
            this.vocab.add(word);
            this.unigram_counts.add(word);
            if (i < corpus.length - 1) {
                let next_word = corpus[i+1];
                if (!this.bigram_counts.has(word)) this.bigram_counts.set(word, new Counter());
                this.bigram_counts.get(word).add(next_word);
            }
        }
        this.vocab_size = this.vocab.size;
    }
    get_probability(word, given_word) {
        let bigram_c = this.get_bigram_count(given_word, word) + this.smoothing;
        let unigram_c = this.unigram_counts.get(given_word) + this.smoothing * this.vocab_size;
        return bigram_c / unigram_c;
    }
    generate_word(given_word) {
        let next_counter = this.bigram_counts.get(given_word);
        let next_words = next_counter ? Array.from(next_counter.keys()) : [];
        if (next_words.length === 0) return '</s>';
        let probabilities = next_words.map(w => this.get_probability(w, given_word));
        return weightedRandom(next_words, probabilities); 
    }
}

class SimpleTrigramLM extends SimpleNGramLMBase {
    train(corpus) {
        for (let i = 0; i < corpus.length; i++) {
            let word = corpus[i];
            this.vocab.add(word);
            this.unigram_counts.add(word);
            if (i < corpus.length - 1) {
                let next_word = corpus[i+1];
                if (!this.bigram_counts.has(word)) this.bigram_counts.set(word, new Counter());
                this.bigram_counts.get(word).add(next_word);
            }
            if (i < corpus.length - 2) {
                let next_word = corpus[i+1];
                let next_next_word = corpus[i+2];
                let bigram_key = word + "|" + next_word;
                if (!this.trigram_counts.has(bigram_key)) this.trigram_counts.set(bigram_key, new Counter());
                this.trigram_counts.get(bigram_key).add(next_next_word);
            }
        }
        this.vocab_size = this.vocab.size;
    }
    get_probability(word, given_word) {
        if (Array.isArray(given_word) && given_word.length === 2) {
            let [w1, w2] = given_word;
            let trigram_c = this.get_trigram_count(w1, w2, word) + this.smoothing;
            let bigram_c = this.get_bigram_count(w1, w2) + this.smoothing * this.vocab_size;
            return trigram_c / bigram_c;
        } else {
            let bg_count = this.get_bigram_count(given_word, word) + this.smoothing;
            let ug_count = this.unigram_counts.get(given_word) + this.smoothing * this.vocab_size;
            return bg_count / ug_count;
        }
    }
    generate_word(given_word) {
        let next_words = [];
        if (Array.isArray(given_word) && given_word.length === 2) {
            let key = given_word[0] + "|" + given_word[1];
            let counter = this.trigram_counts.get(key);
            if (counter) next_words = Array.from(counter.keys());
            else return this.generate_word(given_word[1]);
        } else {
            let counter = this.bigram_counts.get(given_word);
            if (counter) next_words = Array.from(counter.keys());
        }
        if (next_words.length === 0) return '</s>';
        let probabilities = next_words.map(w => this.get_probability(w, given_word));
        return weightedRandom(next_words, probabilities);
    }
}

// --- å…¨å±€çŠ¶æ€ ---
let bigramModel = null;
let trigramModel = null;
let isTrained = false;
let sessionHistory = ['<s>']; 
let currentDOMContainer = null;

// --- ç•Œé¢é€»è¾‘ ---

function scrollToBottom() {
    const box = document.getElementById('consoleOutput');
    box.scrollTop = box.scrollHeight;
}

function updateCursor() {
    if (!currentDOMContainer) return;
    const oldCursor = document.querySelector('.text-cursor');
    if (oldCursor) oldCursor.remove();
    const cursor = document.createElement('span');
    cursor.className = 'text-cursor';
    currentDOMContainer.appendChild(cursor);
}

function ensureContainer() {
    const box = document.getElementById('consoleOutput');
    const isContinuous = document.getElementById('continuousMode').checked;
    const hasContent = box.childNodes.length > 0;
    
    if (!currentDOMContainer || (!isContinuous && hasContent)) {
        if (hasContent) {
            const oldCursor = document.querySelector('.text-cursor');
            if(oldCursor) oldCursor.remove();
            const divider = document.createElement('hr');
            divider.className = "topic-divider";
            box.appendChild(divider);
        } else {
            box.innerHTML = ''; 
        }
        currentDOMContainer = document.createElement('div');
        sessionHistory = ['<s>'];
        box.appendChild(currentDOMContainer);
    }
}

function appendText(text, type) {
    if (!currentDOMContainer) ensureContainer();
    const span = document.createElement('span');
    span.innerText = text;
    if (type === 'user') span.className = 'text-user';
    else if (type === 'model') span.className = 'text-model';
    currentDOMContainer.appendChild(span);
}

function trainModels() {
    const text = document.getElementById('corpusInput').value;
    if (!text.trim()) { alert("è¯·è¾“å…¥è®­ç»ƒæ–‡æœ¬ï¼"); return; }
    let charList = ['<s>', ...text.split(''), '</s>'];
    
    setTimeout(() => {
        try {
            bigramModel = new SimpleBigramLM(); bigramModel.train(charList);
            trigramModel = new SimpleTrigramLM(); trigramModel.train(charList);
            isTrained = true;
            const statusEl = document.getElementById('trainStatus');
            statusEl.innerText = "âœ… æ¨¡å‹å·²å°±ç»ª";
            statusEl.style.color = "#27ae60";
            statusEl.style.fontWeight = "bold";
            document.getElementById('consoleOutput').innerHTML = '<div style="color:gray; text-align:center; padding-top:20px;">æ¨¡å‹å·²åŠ è½½ï¼Œè¾“å…¥æ–‡å­—å¼€å§‹æ¥é¾™...</div>';
            currentDOMContainer = null; 
        } catch (e) {
            alert("è®­ç»ƒå‡ºé”™ï¼š" + e.message);
        }
    }, 10);
}

function getModel() {
    if (!isTrained) { alert("è¯·å…ˆç‚¹å‡»è®­ç»ƒæ¨¡å‹ï¼"); return null; }
    return document.querySelector('input[name="modelType"]:checked').value === 'bigram' ? bigramModel : trigramModel;
}

function generateNextToken() {
    const model = getModel();
    if (!model) return null;
    let nextWord;
    try {
        if (model instanceof SimpleTrigramLM) {
            let context;
            if (sessionHistory.length >= 2) {
                context = [sessionHistory[sessionHistory.length-2], sessionHistory[sessionHistory.length-1]];
            } else {
                context = sessionHistory[sessionHistory.length-1];
            }
            nextWord = model.generate_word(context);
        } else {
            let context = sessionHistory[sessionHistory.length-1];
            nextWord = model.generate_word(context);
        }
    } catch(e) { nextWord = "</s>"; }
    return nextWord;
}

// åŠŸèƒ½1ï¼šéšæœºç”Ÿæˆä¸€æ®µ
function triggerRandomGeneration() {
    if (!isTrained) { alert("è¯·å…ˆè®­ç»ƒæ¨¡å‹"); return; }
    
    ensureContainer();
    
    // é»˜è®¤ç”Ÿæˆé•¿åº¦20ï¼Œå¦‚æœæ‚¨æƒ³è®©è¿™é‡Œçš„é•¿åº¦ä¹Ÿè·Ÿéšé¡¶éƒ¨è¾“å…¥æ¡†ï¼Œ
    // å¯ä»¥æ”¹ä¸º: parseInt(document.getElementById('aiCount').value) || 20;
    const length = parseInt(document.getElementById('aiCount').value) || 20; 
    
    for (let i = 0; i < length; i++) {
        let w = generateNextToken();
        if (w === '</s>') { sessionHistory.push('<s>'); } 
        sessionHistory.push(w);
        appendText(w, 'model');
    }
    updateCursor();
    scrollToBottom();
}

// åŠŸèƒ½2ï¼šå¤„ç†ç”¨æˆ·è¾“å…¥
function processInput() {
    if (!isTrained) { alert("è¯·å…ˆè®­ç»ƒæ¨¡å‹"); return; }

    const inputEl = document.getElementById('userCharInput');
    const val = inputEl.value;
    if (!val) return;

    // å®æ—¶è¯»å–é¡¶éƒ¨çš„AIå­—æ•°è®¾ç½®
    let aiCount = parseInt(document.getElementById('aiCount').value);
    if (isNaN(aiCount) || aiCount < 1) aiCount = 1;

    ensureContainer();

    // 1. ä¸Šå±ç”¨æˆ·è¾“å…¥ (ä¿ç•™æ¢è¡Œç¬¦)
    const chars = val.split('');
    chars.forEach(c => {
        sessionHistory.push(c);
        appendText(c, 'user');
    });

    // 2. ç¬é—´ç”Ÿæˆ AI å›å¤
    for (let i = 0; i < aiCount; i++) {
        let nextW = generateNextToken();
        if (nextW === '</s>') {
            sessionHistory.push('<s>');
        } 
        sessionHistory.push(nextW);
        appendText(nextW, 'model');
    }

    updateCursor();
    scrollToBottom();

    inputEl.value = '';
    inputEl.focus();
}

// é”®ç›˜ç›‘å¬ï¼šEnter å‘é€ï¼ŒCtrl/Cmd + Enter æ¢è¡Œ
document.getElementById('userCharInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        if (e.ctrlKey || e.metaKey) {
            // ç”¨æˆ·æŒ‰ä¸‹äº† Ctrl+Enter (Win) æˆ– Cmd+Enter (Mac) -> æ’å…¥æ¢è¡Œç¬¦
            e.preventDefault();
            const start = this.selectionStart;
            const end = this.selectionEnd;
            const value = this.value;
            // åœ¨å…‰æ ‡ä½ç½®æ’å…¥æ¢è¡Œç¬¦
            this.value = value.substring(0, start) + "\n" + value.substring(end);
            // æ¢å¤å…‰æ ‡ä½ç½®åˆ°æ¢è¡Œç¬¦ä¹‹å
            this.selectionStart = this.selectionEnd = start + 1;
        } else {
            // ä»…æŒ‰ Enter -> å‘é€
            e.preventDefault(); // é˜»æ­¢é»˜è®¤çš„æ¢è¡Œè¡Œä¸º
            processInput();
        }
    }
});

</script>

</body>
</html>